<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨ å¯†æ„ŸçŸ¥å¿«æ”¾ç®—æ³•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 700px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        .label-desc {
            display: block;
            font-weight: normal;
            color: #999;
            font-size: 12px;
            margin-top: 2px;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex-grow: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            transition: all 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }

        .slider-value {
            font-weight: bold;
            color: #667eea;
            min-width: 50px;
            text-align: right;
            font-size: 16px;
        }

        .slider-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            margin-top: 6px;
        }

        .recommendation {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            color: #667eea;
            border-left: 3px solid #667eea;
        }

        .advanced-toggle {
            margin-top: 20px;
            text-align: center;
        }

        .advanced-toggle button {
            background: none;
            border: none;
            color: #667eea;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            padding: 5px 10px;
        }

        .advanced-toggle button:hover {
            color: #764ba2;
        }

        .advanced-options {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }

        .advanced-options.show {
            display: block;
        }

        .advanced-options h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .analysis-progress {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 4px;
        }

        .analysis-progress.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .analysis-result {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background: #d4edda;
            border-left: 3px solid #28a745;
            border-radius: 4px;
            font-size: 13px;
        }

        .analysis-result.show {
            display: block;
        }

        .analysis-result h4 {
            margin-bottom: 10px;
            color: #155724;
        }

        .analysis-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #155724;
        }

        .param-modified {
            background: #fff3cd !important;
            border-left-color: #ffc107 !important;
        }

        .param-modified::before {
            content: "âš ï¸ è‡ªå®šä¹‰å‚æ•° - ";
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:not(:disabled):active {
            transform: translateY(0);
        }

        .loader {
            display: none;
            text-align: center;
            margin-top: 30px;
        }

        .loader p {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
        }

        audio {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .download-link {
            display: inline-block;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .download-link:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .error {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            border-radius: 4px;
            color: #c62828;
            font-size: 14px;
        }

        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .info-box strong {
            color: #333;
        }

        .credit {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #999;
        }

        .credit a {
            color: #667eea;
            text-decoration: none;
        }

        .credit a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 24px;
            }

            .slider-container {
                gap: 10px;
            }

            .slider-value {
                min-width: 40px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ™ï¸ ç¨ å¯†æ„ŸçŸ¥å¿«æ”¾ç®—æ³•</h1>
        <p class="subtitle">æ™ºèƒ½è¯†åˆ«è¯­éŸ³å¯†åº¦ï¼Œè®©å¿«æ”¾æ›´è‡ªç„¶</p>
    </div>

    <div class="info-box">
        <strong>ğŸ’¡ å·¥ä½œåŸç†ï¼š</strong>æœ¬ç®—æ³•é€šè¿‡è¯­éŸ³æ´»åŠ¨æ£€æµ‹(VAD)åˆ†æéŸ³é¢‘çš„è¯­éŸ³å¯†åº¦ç‰¹å¾ï¼Œå¯¹é«˜å¯†åº¦è¯­éŸ³(é‡è¦å†…å®¹)ã€ä½å¯†åº¦è¯­éŸ³(åœé¡¿ã€è¯­æ°”è¯)å’Œé™éŸ³åˆ†åˆ«åº”ç”¨ä¸åŒçš„å˜é€Ÿç³»æ•°ï¼Œåœ¨æé«˜æ’­æ”¾æ•ˆç‡çš„åŒæ—¶ä¿æŒå¬æ„Ÿè‡ªç„¶ã€‚
    </div>

    <form id="upload-form">
        <div class="form-group">
            <label for="audio-file">
                ğŸ“ é€‰æ‹©éŸ³é¢‘æ–‡ä»¶
                <span class="label-desc">æ”¯æŒ MP3, WAV, FLAC, OGG ç­‰æ ¼å¼</span>
            </label>
            <input type="file" id="audio-file" name="file" accept="audio/*" required>
        </div>

        <div class="form-group">
            <label for="base-rate">
                âš¡ è®¾å®šæ’­æ”¾å€é€Ÿ
                <span class="label-desc">æ‚¨åªéœ€è¦è®¾ç½®è¿™ä¸€ä¸ªå‚æ•°ï¼Œç®—æ³•ä¼šæ ¹æ®éŸ³é¢‘ç‰¹å¾è‡ªåŠ¨ä¼˜åŒ–å…¶ä»–å‚æ•°</span>
            </label>
            <div class="slider-container">
                <input type="range" id="base-rate" name="base_rate" min="1.0" max="3.0" step="0.1" value="1.8">
                <span class="slider-value" id="base-rate-value">1.8x</span>
            </div>
            <div class="slider-info">
                <span>1.0x (åŸé€Ÿ)</span>
                <span>3.0x (æœ€å¿«)</span>
            </div>
            <div class="recommendation" id="recommendation">
                ğŸ“Š æ ‡å‡†åŠ é€Ÿï¼Œæ¨èç”¨äºå¤§å¤šæ•°åœºæ™¯
            </div>
        </div>

        <div class="advanced-toggle">
            <button type="button" id="toggle-advanced">ğŸ”§ æ˜¾ç¤ºé«˜çº§é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</button>
        </div>

        <div class="advanced-options" id="advanced-options">
            <h3>âš™ï¸ é«˜çº§å‚æ•°è°ƒèŠ‚</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                ç®—æ³•ä¼šæ ¹æ®æ‚¨ä¸Šä¼ çš„éŸ³é¢‘ç‰¹å¾è‡ªåŠ¨æ¨èæœ€ä¼˜å‚æ•°ã€‚å¦‚æœæ‚¨æƒ³å¾®è°ƒæ•ˆæœï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒæ•´ä»¥ä¸‹å‚æ•°ã€‚
            </p>
            
            <div class="analysis-progress" id="analysis-progress">
                <p style="font-weight: 600; margin-bottom: 5px;">ğŸ” æ­£åœ¨åˆ†æéŸ³é¢‘ç‰¹å¾...</p>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>
            </div>

            <div class="analysis-result" id="analysis-result">
                <h4>âœ… éŸ³é¢‘åˆ†æå®Œæˆ</h4>
                <div id="analysis-description"></div>
                <div class="analysis-stats" id="analysis-stats"></div>
            </div>
            
            <div class="form-group">
                <label for="high-density-factor">
                    ğŸ”¤ é«˜å¯†åº¦è¯­éŸ³è°ƒèŠ‚
                    <span class="label-desc">ä¿ç•™é‡è¦å†…å®¹çš„æ¸…æ™°åº¦ (è¶Šå°è¶Šæ¸…æ™°)</span>
                </label>
                <div class="slider-container">
                    <input type="range" id="high-density-factor" name="high_density_factor" min="0.5" max="1.0" step="0.05" value="0.85">
                    <span class="slider-value" id="high-density-factor-value">0.85</span>
                </div>
                <div class="slider-info">
                    <span>0.5 (æœ€æ¸…æ™°)</span>
                    <span>1.0 (æœ€å¿«)</span>
                </div>
            </div>

            <div class="form-group">
                <label for="low-density-factor">
                    ğŸ’¨ ä½å¯†åº¦è¯­éŸ³è°ƒèŠ‚
                    <span class="label-desc">å‹ç¼©éæ ¸å¿ƒè¯­éŸ³ (è¶Šå¤§å‹ç¼©è¶Šå¤š)</span>
                </label>
                <div class="slider-container">
                    <input type="range" id="low-density-factor" name="low_density_factor" min="1.0" max="2.0" step="0.1" value="1.3">
                    <span class="slider-value" id="low-density-factor-value">1.3</span>
                </div>
                <div class="slider-info">
                    <span>1.0 (ä¸å‹ç¼©)</span>
                    <span>2.0 (æœ€å¤šå‹ç¼©)</span>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px;">
                <button type="button" id="reset-to-recommended" style="width: auto; padding: 8px 16px; font-size: 14px; background: #999;">
                    ğŸ”„ æ¢å¤æ¨èå€¼
                </button>
            </div>
        </div>

        <button type="submit" id="submit-btn">ğŸš€ å¼€å§‹å¤„ç†</button>
    </form>

    <div class="error" id="error"></div>

    <div class="loader" id="loader">
        <p>â³ æ­£åœ¨å¤„ç†éŸ³é¢‘ï¼Œè¯·ç¨å€™...</p>
        <p style="font-size: 12px; color: #999;">è¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œå–å†³äºéŸ³é¢‘é•¿åº¦</p>
        <div class="spinner"></div>
    </div>

    <div class="result" id="result">
        <h2>âœ… å¤„ç†å®Œæˆï¼</h2>
        <audio id="result-audio" controls></audio>
        <a id="download-link" class="download-link" href="#" download>â¬‡ï¸ ä¸‹è½½ç»“æœ</a>
    </div>

    <div class="credit">
        æœ¬é¡¹ç›®ä»£ç ç”± <strong>Manus AI</strong> å®Œæˆ | 
        <a href="https://github.com/neon9809/density-aware" target="_blank">GitHub</a>
    </div>
</div>

<script>
    // å…¨å±€çŠ¶æ€
    let analyzedParams = null;  // å­˜å‚¨åˆ†æå¾—åˆ°çš„æ¨èå‚æ•°
    let userModified = false;   // ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨ä¿®æ”¹äº†å‚æ•°
    let audioAnalyzed = false;  // éŸ³é¢‘æ˜¯å¦å·²åˆ†æ

    // DOMå…ƒç´ 
    const baseRateSlider = document.getElementById('base-rate');
    const baseRateValue = document.getElementById('base-rate-value');
    const recommendation = document.getElementById('recommendation');
    const highDensitySlider = document.getElementById('high-density-factor');
    const highDensityValue = document.getElementById('high-density-factor-value');
    const lowDensitySlider = document.getElementById('low-density-factor');
    const lowDensityValue = document.getElementById('low-density-factor-value');
    const audioFileInput = document.getElementById('audio-file');
    const advancedOptions = document.getElementById('advanced-options');
    const analysisProgress = document.getElementById('analysis-progress');
    const analysisResult = document.getElementById('analysis-result');

    // åŸºå‡†å€é€Ÿæ”¹å˜æ—¶ï¼Œæ›´æ–°æ˜¾ç¤º
    baseRateSlider.addEventListener('input', () => {
        const rate = parseFloat(baseRateSlider.value);
        baseRateValue.textContent = `${rate}x`;
        
        // å¦‚æœéŸ³é¢‘å·²åˆ†æï¼Œé‡æ–°åˆ†æ
        if (audioAnalyzed && audioFileInput.files.length > 0) {
            analyzeAudio();
        }
    });

    // é«˜çº§å‚æ•°æ»‘å—æ›´æ–°
    highDensitySlider.addEventListener('input', () => {
        highDensityValue.textContent = highDensitySlider.value;
        userModified = true;
        updateRecommendationDisplay();
    });

    lowDensitySlider.addEventListener('input', () => {
        lowDensityValue.textContent = lowDensitySlider.value;
        userModified = true;
        updateRecommendationDisplay();
    });

    // åˆ‡æ¢é«˜çº§é€‰é¡¹æ˜¾ç¤º
    document.getElementById('toggle-advanced').addEventListener('click', () => {
        const toggleBtn = document.getElementById('toggle-advanced');
        
        if (advancedOptions.classList.contains('show')) {
            advancedOptions.classList.remove('show');
            toggleBtn.textContent = 'ğŸ”§ æ˜¾ç¤ºé«˜çº§é€‰é¡¹ï¼ˆå¯é€‰ï¼‰';
        } else {
            advancedOptions.classList.add('show');
            toggleBtn.textContent = 'ğŸ”§ éšè—é«˜çº§é€‰é¡¹';
            
            // å±•å¼€æ—¶ï¼Œå¦‚æœæœ‰éŸ³é¢‘æ–‡ä»¶ä¸”æœªåˆ†æï¼Œåˆ™å¼€å§‹åˆ†æ
            if (audioFileInput.files.length > 0 && !audioAnalyzed) {
                analyzeAudio();
            }
        }
    });

    // æ¢å¤æ¨èå€¼
    document.getElementById('reset-to-recommended').addEventListener('click', () => {
        if (analyzedParams) {
            highDensitySlider.value = analyzedParams.high_density_factor;
            highDensityValue.textContent = analyzedParams.high_density_factor;
            lowDensitySlider.value = analyzedParams.low_density_factor;
            lowDensityValue.textContent = analyzedParams.low_density_factor;
            userModified = false;
            updateRecommendationDisplay();
            alert('å·²æ¢å¤ä¸ºæ¨èå€¼ï¼');
        } else {
            alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶è¿›è¡Œåˆ†æï¼');
        }
    });

    // æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶ï¼Œé‡ç½®åˆ†æçŠ¶æ€
    audioFileInput.addEventListener('change', () => {
        audioAnalyzed = false;
        analyzedParams = null;
        analysisResult.classList.remove('show');
    });

    // åˆ†æéŸ³é¢‘
    async function analyzeAudio() {
        const fileInput = document.getElementById('audio-file');
        
        if (!fileInput.files.length) {
            showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('base_rate', baseRateSlider.value);

        // æ˜¾ç¤ºè¿›åº¦æ¡
        analysisProgress.classList.add('show');
        analysisResult.classList.remove('show');
        document.getElementById('progress-bar-fill').style.width = '0%';

        // æ¨¡æ‹Ÿè¿›åº¦
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 90) {
                document.getElementById('progress-bar-fill').style.width = `${progress}%`;
            }
        }, 200);

        try {
            const response = await fetch('/analyze-audio/', {
                method: 'POST',
                body: formData,
            });

            clearInterval(progressInterval);
            document.getElementById('progress-bar-fill').style.width = '100%';

            if (!response.ok) {
                throw new Error(`åˆ†æå¤±è´¥: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success) {
                // ä¿å­˜åˆ†æç»“æœ
                analyzedParams = result.recommendation;
                audioAnalyzed = true;

                // å¦‚æœç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨ä¿®æ”¹ï¼Œåº”ç”¨æ¨èå‚æ•°
                if (!userModified) {
                    highDensitySlider.value = analyzedParams.high_density_factor;
                    highDensityValue.textContent = analyzedParams.high_density_factor;
                    lowDensitySlider.value = analyzedParams.low_density_factor;
                    lowDensityValue.textContent = analyzedParams.low_density_factor;
                }

                // æ˜¾ç¤ºåˆ†æç»“æœ
                displayAnalysisResult(result);
                updateRecommendationDisplay();
            } else {
                throw new Error(result.error || 'åˆ†æå¤±è´¥');
            }

        } catch (error) {
            console.error('åˆ†æå¤±è´¥:', error);
            showError(`éŸ³é¢‘åˆ†æå¤±è´¥: ${error.message}`);
        } finally {
            setTimeout(() => {
                analysisProgress.classList.remove('show');
            }, 500);
        }
    }

    // æ˜¾ç¤ºåˆ†æç»“æœ
    function displayAnalysisResult(result) {
        const descDiv = document.getElementById('analysis-description');
        const statsDiv = document.getElementById('analysis-stats');

        descDiv.innerHTML = `<p style="margin-bottom: 10px;"><strong>${result.recommendation.description}</strong></p>`;

        if (result.analysis) {
            const analysis = result.analysis;
            statsDiv.innerHTML = `
                <div>ğŸ“Š æ€»æ—¶é•¿: ${analysis.total_duration}ç§’</div>
                <div>ğŸ”Š é«˜å¯†åº¦è¯­éŸ³: ${(analysis.high_density_ratio * 100).toFixed(1)}%</div>
                <div>ğŸ’¬ ä½å¯†åº¦è¯­éŸ³: ${(analysis.low_density_ratio * 100).toFixed(1)}%</div>
                <div>ğŸ”‡ é™éŸ³: ${(analysis.silence_ratio * 100).toFixed(1)}%</div>
            `;
        }

        analysisResult.classList.add('show');
    }

    // æ›´æ–°æ¨èæ˜¾ç¤º
    function updateRecommendationDisplay() {
        if (userModified) {
            recommendation.classList.add('param-modified');
            recommendation.textContent = 'ä½¿ç”¨è‡ªå®šä¹‰å‚æ•°';
        } else if (analyzedParams) {
            recommendation.classList.remove('param-modified');
            recommendation.textContent = `ğŸ“Š ${analyzedParams.description}`;
        }
    }

    // è¡¨å•æäº¤
    const form = document.getElementById('upload-form');
    const submitBtn = document.getElementById('submit-btn');
    const loader = document.getElementById('loader');
    const resultDiv = document.getElementById('result');
    const resultAudio = document.getElementById('result-audio');
    const downloadLink = document.getElementById('download-link');
    const errorDiv = document.getElementById('error');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById('audio-file');
        
        if (!fileInput.files.length) {
            showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼');
            return;
        }

        // å¦‚æœéŸ³é¢‘æœªåˆ†æï¼Œå…ˆåˆ†æ
        if (!audioAnalyzed) {
            try {
                await analyzeAudio();
            } catch (error) {
                showError('éŸ³é¢‘åˆ†æå¤±è´¥ï¼Œæ— æ³•ç»§ç»­å¤„ç†');
                return;
            }
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('base_rate', baseRateSlider.value);
        
        // æ ¹æ®ç”¨æˆ·æ˜¯å¦ä¿®æ”¹å‚æ•°ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨æ¨èå€¼
        formData.append('use_recommended', !userModified);
        
        if (userModified) {
            formData.append('high_density_factor', highDensitySlider.value);
            formData.append('low_density_factor', lowDensitySlider.value);
        } else if (analyzedParams) {
            formData.append('high_density_factor', analyzedParams.high_density_factor);
            formData.append('low_density_factor', analyzedParams.low_density_factor);
        }

        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        submitBtn.disabled = true;
        submitBtn.textContent = 'å¤„ç†ä¸­...';
        loader.style.display = 'block';
        resultDiv.style.display = 'none';

        try {
            const response = await fetch('/process-audio/', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                let errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorMessage;
                } catch (e) {
                    // æ— æ³•è§£æJSONï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
                }
                throw new Error(errorMessage);
            }

            // è·å–è¿”å›çš„éŸ³é¢‘æ–‡ä»¶ blob
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);

            // æ˜¾ç¤ºç»“æœ
            resultAudio.src = audioUrl;
            downloadLink.href = audioUrl;
            
            // ä»å“åº”å¤´è·å–å»ºè®®çš„æ–‡ä»¶å
            const contentDisposition = response.headers.get('content-disposition');
            let fileName = 'processed_audio.mp3';
            if (contentDisposition) {
                const fileNameMatch = contentDisposition.match(/filename="(.+)"/);
                if (fileNameMatch && fileNameMatch.length === 2)
                    fileName = fileNameMatch[1];
            }
            downloadLink.download = fileName;
            
            resultDiv.style.display = 'block';

        } catch (error) {
            console.error('å¤„ç†å¤±è´¥:', error);
            showError(`å¤„ç†å¤±è´¥: ${error.message}`);
        } finally {
            // æ¢å¤æŒ‰é’®å’ŒåŠ è½½çŠ¶æ€
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
            loader.style.display = 'none';
        }
    });

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
</script>

</body>
</html>
